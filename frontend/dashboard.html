<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatchDB - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">PatchDB</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="userGreeting"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- User Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">Your Collection</h2>
            </div>
            <div class="col-6 col-md-4 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="uniquePatches">-</div>
                    <div class="stat-label">Unique Patches</div>
                </div>
            </div>
            <div class="col-6 col-md-4 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalPatches">-</div>
                    <div class="stat-label">Total Patches</div>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3" id="ungroupedCard">
                <div class="stat-card">
                    <div class="stat-number" id="ungroupedPatches">-</div>
                    <div class="stat-label">Ungrouped</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 class="h5 mb-3">Quick Actions</h3>
            </div>
            <div class="col-12 col-sm-6 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column text-center">
                        <div class="mb-3">
                            <svg class="mb-2" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.52 10.724l-2.005-2.005A.5.5 0 0 0 4.229 8.7l-3.226 3.226A1 1 0 0 1 1.002 13V3a1 1 0 0 1 1-1h12z"/>
                            </svg>
                        </div>
                        <h4 class="h6 mb-2">Add New Patch</h4>
                        <p class="text-muted mb-3 flex-grow-1">Take a photo or upload an image of your new patch</p>
                        <a href="upload.html" class="btn btn-dark">Upload Patch</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column text-center">
                        <div class="mb-3">
                            <svg class="mb-2" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
                            </svg>
                        </div>
                        <h4 class="h6 mb-2">View Collection</h4>
                        <p class="text-muted mb-3 flex-grow-1">Browse and organize your existing patches</p>
                        <a href="collection.html" class="btn btn-outline-dark">View Patches</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity (if any patches exist) -->
        <div class="row" id="recentActivity" style="display: none;">
            <div class="col-12">
                <h3 class="h5 mb-3">Recent Patches</h3>
                <div class="row" id="recentPatches">
                    <!-- Recent patches will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Error/Success Messages -->
        <div id="errorContainer"></div>
        <div id="successContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        let userId, username;

        async function loadDashboard() {
            // Check authentication
            userId = requireAuth();
            if (!userId) return;

            username = localStorage.getItem('username');
            
            // Update greeting
            document.getElementById('userGreeting').textContent = `Hello, ${username}`;

            try {
                showLoading();
                
                // Load user patches to calculate stats
                const data = await getUserPatches(userId);
                updateStats(data);
                
                // Show recent patches if any exist
                if (data.patches.length > 0 || data.ungrouped_patches.length > 0) {
                    showRecentPatches(data);
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard data: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function updateStats(data) {
            // Calculate stats
            const uniquePatches = data.patches.length + data.ungrouped_patches.length;
            const totalPatches = data.patches.reduce((total, group) => total + group.images.length, 0) + 
                               data.ungrouped_patches.length;
            const ungroupedCount = data.ungrouped_patches.length;

            // Update display
            document.getElementById('uniquePatches').textContent = uniquePatches;
            document.getElementById('totalPatches').textContent = totalPatches;
            document.getElementById('ungroupedPatches').textContent = ungroupedCount;

            // Show/hide ungrouped card based on count
            const ungroupedCard = document.getElementById('ungroupedCard');
            if (ungroupedCount > 0) {
                ungroupedCard.style.display = 'block';
            } else {
                ungroupedCard.style.display = 'none';
            }
        }

        function showRecentPatches(data) {
            const recentActivity = document.getElementById('recentActivity');
            const recentPatches = document.getElementById('recentPatches');
            
            // Get up to 4 most recent patches (simplified - showing first few)
            let patches = [];
            
            // Add grouped patches (take first image from each group)
            data.patches.forEach(group => {
                if (group.images.length > 0) {
                    patches.push({
                        name: group.name,
                        path: group.images[0].path,
                        isGroup: true
                    });
                }
            });
            
            // Add ungrouped patches
            data.ungrouped_patches.forEach(patch => {
                patches.push({
                    name: 'Ungrouped',
                    path: patch.path,
                    isGroup: false
                });
            });
            
            // Show only first 4 patches
            patches = patches.slice(0, 4);
            
            if (patches.length > 0) {
                recentPatches.innerHTML = patches.map(patch => `
                    <div class="col-6 col-lg-3 mb-3">
                        <div class="card">
                            <div class="patch-item">
                                <img src="${formatImagePath(patch.path)}" alt="${patch.name}" class="card-img-top">
                            </div>
                            <div class="card-body p-2">
                                <p class="card-text small text-center mb-0">${patch.name}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                recentActivity.style.display = 'block';
            }
        }

        // Initialize dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
