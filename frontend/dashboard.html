<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatchDB - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">PatchDB</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="userGreeting"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- User Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">Your Collection</h2>
            </div>
            <div class="col-6 col-md-4 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="uniquePatches">-</div>
                    <div class="stat-label">Unique Patches</div>
                </div>
            </div>
            <div class="col-6 col-md-4 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="totalPatches">-</div>
                    <div class="stat-label">Total Patches</div>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3" id="ungroupedCard">
                <div class="stat-card">
                    <div class="stat-number" id="ungroupedPatches">-</div>
                    <div class="stat-label">Ungrouped</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 class="h5 mb-3">Quick Actions</h3>
            </div>
            <div class="col-12 col-md-6 col-lg-4 mb-3 mx-auto">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column text-center">
                        <div class="mb-3">
                            <svg class="mb-2" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.52 10.724l-2.005-2.005A.5.5 0 0 0 4.229 8.7l-3.226 3.226A1 1 0 0 1 1.002 13V3a1 1 0 0 1 1-1h12z"/>
                            </svg>
                        </div>
                        <h4 class="h6 mb-2">Add New Patch</h4>
                        <p class="text-muted mb-3 flex-grow-1">Take a photo or upload an image of your new patch</p>
                        <a href="upload.html" class="btn btn-dark">Upload Patch</a>
                    </div>
                </div>
            </div>
                        </div>

        <!-- Search/Filter -->
        <div class="row mb-4" id="searchFilterSection" style="display: none;">
            <div class="col-12">
                <h3 class="h5 mb-3">Your Patch Collection</h3>
                    </div>
            <div class="col-12 col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search patches..." onkeyup="filterPatches()">
                    <span class="input-group-text">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                    </span>
                </div>
            </div>
            <div class="col-12 col-md-6 mt-2 mt-md-0">
                <select class="form-select" id="filterSelect" onchange="filterPatches()">
                    <option value="all">All Patches</option>
                    <option value="grouped">Grouped Only</option>
                    <option value="ungrouped">Ungrouped Only</option>
                </select>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5 d-none">
            <svg class="mb-3 text-muted" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.52 10.724l-2.005-2.005A.5.5 0 0 0 4.229 8.7l-3.226 3.226A1 1 0 0 1 1.002 13V3a1 1 0 0 1 1-1h12z"/>
            </svg>
            <h3 class="h5">No Patches Yet</h3>
            <p class="text-muted mb-3">Start building your patch collection by uploading your first patch!</p>
            <a href="upload.html" class="btn btn-dark">Add Your First Patch</a>
        </div>

        <!-- Grouped Patches -->
        <div id="groupedPatches"></div>

        <!-- Ungrouped Patches -->
        <div id="ungroupedSection" class="d-none">
            <div class="row mb-3">
            <div class="col-12">
                    <h2 class="h5">Ungrouped Patches</h2>
                    <p class="text-muted small">These patches haven't been organized into groups yet.</p>
                </div>
            </div>
            <div class="patch-grid mb-4" id="ungroupedPatches"></div>
        </div>

        <!-- Error/Success Messages -->
        <div id="errorContainer"></div>
        <div id="successContainer"></div>
    </div>

    <!-- Patch Detail Modal -->
    <div class="modal fade" id="patchModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Patch Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid rounded" style="max-height: 400px;">
                    <div id="modalInfo" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="deletePatchBtn" onclick="confirmDeletePatch()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                        Delete Patch
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add to Group Modal -->
    <div class="modal fade" id="addToGroupModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Patch to Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-4">
                            <img id="selectedPatchImage" class="img-fluid rounded" style="width: 100%; aspect-ratio: 1; object-fit: cover;">
                        </div>
                        <div class="col-8">
                            <h6>Choose a group for this patch:</h6>
                            <div id="existingGroupsList" class="mb-3">
                                <!-- Existing groups will be loaded here -->
                            </div>
                            <div class="border-top pt-3">
                                <h6>Or create a new group:</h6>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="newGroupName" placeholder="Enter group name">
                                    <button class="btn btn-outline-dark" type="button" id="createNewGroupBtn">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        let userId, username;
        let allPatches = { patches: [], ungrouped_patches: [] };
        let patchModal;
        let addToGroupModal;
        let currentPatchId = null;
        let selectedPatchForGrouping = null;

        async function loadDashboard() {
            // Check authentication
            userId = requireAuth();
            if (!userId) return;

            username = localStorage.getItem('username');
            
            // Initialize modals
            patchModal = new bootstrap.Modal(document.getElementById('patchModal'));
            addToGroupModal = new bootstrap.Modal(document.getElementById('addToGroupModal'));
            
            // Update greeting
            document.getElementById('userGreeting').textContent = `Hello, ${username}`;

            try {
                showLoading();
                
                // Load user patches to calculate stats and show collection
                const data = await getUserPatches(userId);
                updateStats(data);
                
                if (data.patches.length === 0 && data.ungrouped_patches.length === 0) {
                    showEmptyState();
                } else {
                    displayCollection(data);
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard data: ' + error.message);
            } finally {
                hideLoading();
            }
            
            // Initialize event listeners for add to group modal
            initializeAddToGroupModal();
        }

        function initializeAddToGroupModal() {
            // Handle creating new group
            document.getElementById('createNewGroupBtn').addEventListener('click', async function() {
                const groupName = document.getElementById('newGroupName').value.trim();
                if (!groupName) {
                    showError('Please enter a group name');
                    return;
                }
                
                await addPatchToNewGroup(selectedPatchForGrouping, groupName);
            });
            
            // Handle Enter key in new group input
            document.getElementById('newGroupName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('createNewGroupBtn').click();
                }
            });

            // Add keyboard shortcut for search
            document.getElementById('searchInput').addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    filterPatches();
                }
            });
        }

        function updateStats(data) {
            // Calculate stats
            const uniquePatches = data.patches.length + data.ungrouped_patches.length;
            const totalPatches = data.patches.reduce((total, group) => total + group.images.length, 0) + 
                               data.ungrouped_patches.length;
            const ungroupedCount = data.ungrouped_patches.length;

            // Update display
            document.getElementById('uniquePatches').textContent = uniquePatches;
            document.getElementById('totalPatches').textContent = totalPatches;
            document.getElementById('ungroupedPatches').textContent = ungroupedCount;

            // Show/hide ungrouped card based on count
            const ungroupedCard = document.getElementById('ungroupedCard');
            if (ungroupedCount > 0) {
                ungroupedCard.style.display = 'block';
            } else {
                ungroupedCard.style.display = 'none';
            }
        }

        function displayCollection(data) {
            allPatches = data;
            
            // Show search/filter section if there are patches
            if (data.patches.length > 0 || data.ungrouped_patches.length > 0) {
                document.getElementById('searchFilterSection').style.display = 'block';
            }
            
            displayGroupedPatches(data.patches);
            displayUngroupedPatches(data.ungrouped_patches);
        }

        function displayGroupedPatches(patches) {
            const container = document.getElementById('groupedPatches');
            
            if (patches.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            patches.forEach(group => {
                const imageCount = group.images.length;
                
                html += `
                    <div class="row mb-4 patch-group" data-name="${group.name.toLowerCase()}">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="h5 mb-0">${group.name}</h2>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-secondary me-2">${imageCount} image${imageCount > 1 ? 's' : ''}</span>
                                    <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteGroup(${group.id}, '${group.name.replace(/'/g, "\\'")}')" title="Delete group">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="patch-grid">
                `;
                
                group.images.forEach((image, index) => {
                    html += `
                        <div class="patch-item cursor-pointer" onclick="showPatchDetail('${image.path}', '${group.name}', 'Group ${index + 1} of ${imageCount}', ${image.id})">
                            <img src="${formatImagePath(image.path)}" alt="${group.name}" loading="lazy">
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function displayUngroupedPatches(patches) {
            const section = document.getElementById('ungroupedSection');
            const container = document.getElementById('ungroupedPatches');
            
            if (patches.length === 0) {
                section.classList.add('d-none');
                return;
            }

            section.classList.remove('d-none');
            
            let html = '';
            patches.forEach(patch => {
                html += `
                    <div class="patch-item cursor-pointer ungrouped-patch" onclick="showAddToGroupModal(${patch.id}, '${patch.path}')">
                        <img src="${formatImagePath(patch.path)}" alt="Ungrouped patch" loading="lazy">
                        <div class="patch-overlay">
                            <div class="patch-overlay-text">
                                <svg width="24" height="24" fill="white" viewBox="0 0 16 16">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                </svg>
                                <div class="small">Add to Group</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showAddToGroupModal(patchId, patchPath) {
            selectedPatchForGrouping = patchId;
            document.getElementById('selectedPatchImage').src = formatImagePath(patchPath);
            document.getElementById('newGroupName').value = '';
            
            // Load existing groups
            populateExistingGroups();
            
            addToGroupModal.show();
        }

        function populateExistingGroups() {
            const container = document.getElementById('existingGroupsList');
            
            if (allPatches.patches.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">No existing groups. Create a new one below.</p>';
                return;
            }
            
            let html = '';
            allPatches.patches.forEach(group => {
                const firstImage = group.images[0];
                html += `
                    <div class="d-flex align-items-center mb-2 p-2 border rounded cursor-pointer existing-group-item" 
                         onclick="addPatchToExistingGroup(${selectedPatchForGrouping}, ${group.id}, '${group.name.replace(/'/g, "\\'")}')">
                        <img src="${formatImagePath(firstImage.path)}" alt="${group.name}" 
                             class="me-2 rounded" style="width: 40px; height: 40px; object-fit: cover;">
                        <div>
                            <div class="fw-semibold">${group.name}</div>
                            <small class="text-muted">${group.images.length} image${group.images.length > 1 ? 's' : ''}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function addPatchToExistingGroup(patchId, groupId, groupName) {
            try {
                showLoading();
                await addPatchToGroup(userId, patchId, groupId);
                addToGroupModal.hide();
                showSuccess(`Patch added to "${groupName}" successfully`);
                await loadCollection(); // Reload the collection
            } catch (error) {
                console.error('Error adding patch to group:', error);
                showError('Failed to add patch to group: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function addPatchToNewGroup(patchId, groupName) {
            try {
                showLoading();
                await createPatchGroup(userId, patchId, groupName);
                addToGroupModal.hide();
                showSuccess(`New group "${groupName}" created successfully`);
                await loadCollection(); // Reload the collection
            } catch (error) {
                console.error('Error creating new group:', error);
                showError('Failed to create new group: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadCollection() {
            try {
                showLoading();
                
                const data = await getUserPatches(userId);
                updateStats(data);
                
                if (data.patches.length === 0 && data.ungrouped_patches.length === 0) {
                    showEmptyState();
                } else {
                    displayCollection(data);
                }
                
            } catch (error) {
                console.error('Error loading collection:', error);
                showError('Failed to load your collection: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showPatchDetail(imagePath, title, subtitle, patchId) {
            currentPatchId = patchId;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalImage').src = formatImagePath(imagePath);
            document.getElementById('modalInfo').innerHTML = `<p class="text-muted mb-0">${subtitle}</p>`;
            patchModal.show();
        }

        function filterPatches() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterType = document.getElementById('filterSelect').value;
            
            // Filter grouped patches
            const groupedPatches = document.querySelectorAll('.patch-group');
            let visibleGroupedCount = 0;
            
            groupedPatches.forEach(group => {
                const groupName = group.dataset.name;
                const matchesSearch = groupName.includes(searchTerm);
                const shouldShow = (filterType === 'all' || filterType === 'grouped') && matchesSearch;
                
                group.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleGroupedCount++;
            });
            
            // Filter ungrouped patches
            const ungroupedPatches = document.querySelectorAll('.ungrouped-patch');
            let visibleUngroupedCount = 0;
            
            ungroupedPatches.forEach(patch => {
                const shouldShow = filterType === 'all' || filterType === 'ungrouped';
                patch.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleUngroupedCount++;
            });
            
            // Show/hide ungrouped section
            const ungroupedSection = document.getElementById('ungroupedSection');
            if (filterType === 'grouped' || (filterType === 'ungrouped' && visibleUngroupedCount === 0)) {
                ungroupedSection.classList.add('d-none');
            } else if (allPatches.ungrouped_patches.length > 0) {
                ungroupedSection.classList.remove('d-none');
            }
            
            // Show empty state if nothing is visible
            const hasVisibleContent = visibleGroupedCount > 0 || 
                (visibleUngroupedCount > 0 && (filterType === 'all' || filterType === 'ungrouped'));
            
            if (!hasVisibleContent && (allPatches.patches.length > 0 || allPatches.ungrouped_patches.length > 0)) {
                showNoResults();
            } else {
                hideNoResults();
            }
        }

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('d-none');
            document.getElementById('groupedPatches').innerHTML = '';
            document.getElementById('ungroupedSection').classList.add('d-none');
            document.getElementById('searchFilterSection').style.display = 'none';
        }

        function showNoResults() {
            const container = document.getElementById('groupedPatches');
            container.innerHTML = `
                <div class="text-center py-5">
                    <svg class="mb-3 text-muted" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    <h3 class="h6">No patches match your search</h3>
                    <p class="text-muted small">Try adjusting your search term or filter</p>
                </div>
            `;
        }

        function hideNoResults() {
            // Only hide if we're showing search results, not empty state
            if (allPatches.patches.length > 0 || allPatches.ungrouped_patches.length > 0) {
                displayGroupedPatches(allPatches.patches);
            }
        }

        async function confirmDeletePatch() {
            if (!currentPatchId) {
                showError('No patch selected for deletion');
                return;
            }

            if (!confirm('Are you sure you want to delete this patch? This action cannot be undone.')) {
                return;
            }

            try {
                showLoading();
                await deletePatch(userId, currentPatchId);
                patchModal.hide();
                showSuccess('Patch deleted successfully');
                await loadCollection(); // Reload the collection
            } catch (error) {
                console.error('Error deleting patch:', error);
                showError('Failed to delete patch: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function confirmDeleteGroup(groupId, groupName) {
            if (!confirm(`Are you sure you want to delete the group "${groupName}" and all patches in it? This action cannot be undone.`)) {
                return;
            }

            try {
                showLoading();
                await deletePatchGroup(userId, groupId);
                showSuccess(`Group "${groupName}" deleted successfully`);
                await loadCollection(); // Reload the collection
            } catch (error) {
                console.error('Error deleting group:', error);
                showError('Failed to delete group: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Initialize dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
