<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatchDB - Upload Patch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">PatchDB</a>
            <div class="navbar-nav ms-auto">
                <a href="dashboard.html" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h2 class="h5 mb-0">Add New Patch</h2>
                        <small class="text-muted">Take a photo or upload an image of your patch</small>
                    </div>
                    <div class="card-body">
                        
                        <!-- Upload Methods -->
                        <div class="row mb-4" id="uploadMethods">
                            <div class="col-12 col-sm-6 mb-3">
                                <button class="btn btn-outline-dark w-100 p-3" id="cameraBtn" onclick="showCamera()">
                                    <svg class="mb-2" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
                                        <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
                                    </svg>
                                    <div>Take Photo</div>
                                </button>
                            </div>
                            <div class="col-12 col-sm-6 mb-3">
                                <label for="fileInput" class="btn btn-outline-dark w-100 p-3 mb-0">
                                    <svg class="mb-2" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                    </svg>
                                    <div>Upload File</div>
                                </label>
                                <input type="file" id="fileInput" accept="image/*" class="d-none" onchange="handleFileSelect(this)">
                            </div>
                        </div>

                        <!-- Camera View -->
                        <div id="cameraView" class="d-none">
                            <div class="camera-container mb-3">
                                <video id="videoElement" class="w-100" autoplay playsinline></video>
                                <div class="camera-controls">
                                    <button class="capture-btn" onclick="capturePhoto()"></button>
                                </div>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-secondary" onclick="hideCamera()">Cancel</button>
                            </div>
                        </div>

                        <!-- Image Preview -->
                        <div id="imagePreview" class="d-none">
                            <div class="text-center mb-3">
                                <img id="previewImage" class="image-preview" style="max-height: 400px;">
                            </div>
                            
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-secondary" onclick="clearImage()">Choose Different Image</button>
                                <button class="btn btn-dark" onclick="uploadImage()" id="uploadBtn">
                                    <span class="spinner-border spinner-border-sm d-none me-2" id="uploadSpinner"></span>
                                    Upload Patch
                                </button>
                            </div>
                        </div>

                        <!-- Drag & Drop Area -->
                        <div id="dropArea" class="upload-area mb-3">
                            <svg class="mb-3" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.52 10.724l-2.005-2.005A.5.5 0 0 0 4.229 8.7l-3.226 3.226A1 1 0 0 1 1.002 13V3a1 1 0 0 1 1-1h12z"/>
                            </svg>
                            <h4 class="h6">Drag & Drop Image Here</h4>
                            <p class="text-muted mb-0">Or use the buttons above</p>
                        </div>

                        <!-- Error/Success Messages -->
                        <div id="errorContainer"></div>
                        <div id="successContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        let userId;
        let currentStream;
        let selectedFile;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            userId = requireAuth();
            if (!userId) return;

            setupDragAndDrop();
        });

        function setupDragAndDrop() {
            const dropArea = document.getElementById('dropArea');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('dragover');
            }

            function unhighlight() {
                dropArea.classList.remove('dragover');
            }

            dropArea.addEventListener('drop', handleDrop, false);
            dropArea.addEventListener('click', () => document.getElementById('fileInput').click());

            function handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({files: files});
                }
            }
        }

        async function showCamera() {
            try {
                currentStream = await initializeCamera();
                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = currentStream;

                document.getElementById('uploadMethods').style.display = 'none';
                document.getElementById('dropArea').style.display = 'none';
                document.getElementById('cameraView').classList.remove('d-none');
            } catch (error) {
                showError('Camera access failed: ' + error.message);
            }
        }

        function hideCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            document.getElementById('cameraView').classList.add('d-none');
            document.getElementById('uploadMethods').style.display = 'block';
            document.getElementById('dropArea').style.display = 'block';
        }

        async function capturePhoto() {
            try {
                const videoElement = document.getElementById('videoElement');
                const imageBlob = await captureImage(videoElement);
                
                // Convert to file
                selectedFile = new File([imageBlob], 'camera-capture.jpg', { type: 'image/jpeg' });
                
                hideCamera();
                showImagePreview(selectedFile);
            } catch (error) {
                showError('Failed to capture photo: ' + error.message);
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showError('Please select an image file.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showError('File size must be less than 10MB.');
                return;
            }

            selectedFile = file;
            showImagePreview(file);
        }

        function showImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadMethods').style.display = 'none';
                document.getElementById('dropArea').style.display = 'none';
                document.getElementById('imagePreview').classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            selectedFile = null;
            document.getElementById('imagePreview').classList.add('d-none');
            document.getElementById('uploadMethods').style.display = 'block';
            document.getElementById('dropArea').style.display = 'block';
            document.getElementById('fileInput').value = '';
        }

        async function uploadImage() {
            if (!selectedFile) {
                showError('Please select an image first.');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const spinner = document.getElementById('uploadSpinner');

            try {
                uploadBtn.disabled = true;
                spinner.classList.remove('d-none');

                // Resize image if needed
                let fileToUpload = selectedFile;
                if (selectedFile.size > 2 * 1024 * 1024) { // If larger than 2MB, resize
                    fileToUpload = await resizeImage(selectedFile, 1200, 900, 0.8);
                }

                const result = await uploadPatch(userId, fileToUpload);
                
                // Store upload result for matches page
                sessionStorage.setItem('uploadResult', JSON.stringify(result));
                
                // Redirect to matches page
                window.location.href = 'matches.html';
                
            } catch (error) {
                showError('Upload failed: ' + error.message);
            } finally {
                uploadBtn.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        // Check for camera support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('cameraBtn').disabled = true;
            document.getElementById('cameraBtn').innerHTML = `
                <svg class="mb-2" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
                    <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/>
                </svg>
                <div><small>Camera Not Available</small></div>
            `;
        }
    </script>
</body>
</html>
