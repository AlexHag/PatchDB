<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PatchDB - My Collection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">PatchDB</a>
            <div class="navbar-nav ms-auto">
                <a href="upload.html" class="btn btn-outline-light btn-sm me-2">Add Patch</a>
                <a href="dashboard.html" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-1">My Patch Collection</h1>
                        <p class="text-muted mb-0" id="collectionStats">Loading...</p>
                    </div>
                    <a href="upload.html" class="btn btn-dark">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        Add Patch
                    </a>
                </div>
            </div>
        </div>

        <!-- Search/Filter -->
        <div class="row mb-4">
            <div class="col-12 col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search patches..." onkeyup="filterPatches()">
                    <span class="input-group-text">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                    </span>
                </div>
            </div>
            <div class="col-12 col-md-6 mt-2 mt-md-0">
                <select class="form-select" id="filterSelect" onchange="filterPatches()">
                    <option value="all">All Patches</option>
                    <option value="grouped">Grouped Only</option>
                    <option value="ungrouped">Ungrouped Only</option>
                </select>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5 d-none">
            <svg class="mb-3 text-muted" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.52 10.724l-2.005-2.005A.5.5 0 0 0 4.229 8.7l-3.226 3.226A1 1 0 0 1 1.002 13V3a1 1 0 0 1 1-1h12z"/>
            </svg>
            <h3 class="h5">No Patches Yet</h3>
            <p class="text-muted mb-3">Start building your patch collection by uploading your first patch!</p>
            <a href="upload.html" class="btn btn-dark">Add Your First Patch</a>
        </div>

        <!-- Grouped Patches -->
        <div id="groupedPatches"></div>

        <!-- Ungrouped Patches -->
        <div id="ungroupedSection" class="d-none">
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="h5">Ungrouped Patches</h2>
                    <p class="text-muted small">These patches haven't been organized into groups yet.</p>
                </div>
            </div>
            <div class="patch-grid mb-4" id="ungroupedPatches"></div>
        </div>

        <!-- Error/Success Messages -->
        <div id="errorContainer"></div>
        <div id="successContainer"></div>
    </div>

    <!-- Patch Detail Modal -->
    <div class="modal fade" id="patchModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Patch Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid rounded" style="max-height: 400px;">
                    <div id="modalInfo" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        let userId;
        let allPatches = { patches: [], ungrouped_patches: [] };
        let patchModal;

        document.addEventListener('DOMContentLoaded', async function() {
            userId = requireAuth();
            if (!userId) return;

            patchModal = new bootstrap.Modal(document.getElementById('patchModal'));
            await loadCollection();
        });

        async function loadCollection() {
            try {
                showLoading();
                
                const data = await getUserPatches(userId);
                allPatches = data;
                
                if (data.patches.length === 0 && data.ungrouped_patches.length === 0) {
                    showEmptyState();
                } else {
                    displayCollection(data);
                }
                
            } catch (error) {
                console.error('Error loading collection:', error);
                showError('Failed to load your collection: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayCollection(data) {
            updateStats(data);
            displayGroupedPatches(data.patches);
            displayUngroupedPatches(data.ungrouped_patches);
        }

        function updateStats(data) {
            const uniqueCount = data.patches.length + data.ungrouped_patches.length;
            const totalCount = data.patches.reduce((total, group) => total + group.images.length, 0) + 
                              data.ungrouped_patches.length;
            
            document.getElementById('collectionStats').textContent = 
                `${uniqueCount} unique patches â€¢ ${totalCount} total patches`;
        }

        function displayGroupedPatches(patches) {
            const container = document.getElementById('groupedPatches');
            
            if (patches.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            patches.forEach(group => {
                const imageCount = group.images.length;
                const firstImage = group.images[0];
                
                html += `
                    <div class="row mb-4 patch-group" data-name="${group.name.toLowerCase()}">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="h5 mb-0">${group.name}</h2>
                                <span class="badge bg-secondary">${imageCount} image${imageCount > 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="patch-grid">
                `;
                
                group.images.forEach((image, index) => {
                    html += `
                        <div class="patch-item cursor-pointer" onclick="showPatchDetail('${image.path}', '${group.name}', 'Group ${index + 1} of ${imageCount}')">
                            <img src="${formatImagePath(image.path)}" alt="${group.name}" loading="lazy">
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function displayUngroupedPatches(patches) {
            const section = document.getElementById('ungroupedSection');
            const container = document.getElementById('ungroupedPatches');
            
            if (patches.length === 0) {
                section.classList.add('d-none');
                return;
            }

            section.classList.remove('d-none');
            
            let html = '';
            patches.forEach(patch => {
                html += `
                    <div class="patch-item cursor-pointer ungrouped-patch" onclick="showPatchDetail('${patch.path}', 'Ungrouped Patch', 'This patch hasn\\'t been organized yet')">
                        <img src="${formatImagePath(patch.path)}" alt="Ungrouped patch" loading="lazy">
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showPatchDetail(imagePath, title, subtitle) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalImage').src = formatImagePath(imagePath);
            document.getElementById('modalInfo').innerHTML = `<p class="text-muted mb-0">${subtitle}</p>`;
            patchModal.show();
        }

        function filterPatches() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterType = document.getElementById('filterSelect').value;
            
            // Filter grouped patches
            const groupedPatches = document.querySelectorAll('.patch-group');
            let visibleGroupedCount = 0;
            
            groupedPatches.forEach(group => {
                const groupName = group.dataset.name;
                const matchesSearch = groupName.includes(searchTerm);
                const shouldShow = (filterType === 'all' || filterType === 'grouped') && matchesSearch;
                
                group.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleGroupedCount++;
            });
            
            // Filter ungrouped patches
            const ungroupedPatches = document.querySelectorAll('.ungrouped-patch');
            let visibleUngroupedCount = 0;
            
            ungroupedPatches.forEach(patch => {
                const shouldShow = filterType === 'all' || filterType === 'ungrouped';
                patch.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleUngroupedCount++;
            });
            
            // Show/hide ungrouped section
            const ungroupedSection = document.getElementById('ungroupedSection');
            if (filterType === 'grouped' || (filterType === 'ungrouped' && visibleUngroupedCount === 0)) {
                ungroupedSection.classList.add('d-none');
            } else if (allPatches.ungrouped_patches.length > 0) {
                ungroupedSection.classList.remove('d-none');
            }
            
            // Show empty state if nothing is visible
            const hasVisibleContent = visibleGroupedCount > 0 || 
                (visibleUngroupedCount > 0 && (filterType === 'all' || filterType === 'ungrouped'));
            
            if (!hasVisibleContent && (allPatches.patches.length > 0 || allPatches.ungrouped_patches.length > 0)) {
                showNoResults();
            } else {
                hideNoResults();
            }
        }

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('d-none');
            document.getElementById('groupedPatches').innerHTML = '';
            document.getElementById('ungroupedSection').classList.add('d-none');
        }

        function showNoResults() {
            const container = document.getElementById('groupedPatches');
            container.innerHTML = `
                <div class="text-center py-5">
                    <svg class="mb-3 text-muted" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    <h3 class="h6">No patches match your search</h3>
                    <p class="text-muted small">Try adjusting your search term or filter</p>
                </div>
            `;
        }

        function hideNoResults() {
            // Only hide if we're showing search results, not empty state
            if (allPatches.patches.length > 0 || allPatches.ungrouped_patches.length > 0) {
                displayGroupedPatches(allPatches.patches);
            }
        }

        // Add keyboard shortcut for search
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                filterPatches();
            }
        });
    </script>
</body>
</html>
